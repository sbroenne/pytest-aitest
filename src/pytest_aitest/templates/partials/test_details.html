{# Test details partial - metrics, mermaid diagram, conversation for a single test #}
{# Expects: test (TestReport) #}

{% if test.error %}
<div class="error-message">{{ test.error }}</div>
{% endif %}

{% if test.agent_result %}
<div class="metrics-grid">
    <div class="metric">
        <div class="metric-value">{{ "%.2f"|format(test.agent_result.duration_ms / 1000) }}s</div>
        <div class="metric-label">Duration</div>
    </div>
    <div class="metric">
        <div class="metric-value">{{ test.agent_result.token_usage.get('prompt', 0) }}</div>
        <div class="metric-label">Prompt Tokens</div>
    </div>
    <div class="metric">
        <div class="metric-value">{{ test.agent_result.token_usage.get('completion', 0) }}</div>
        <div class="metric-label">Completion Tokens</div>
    </div>
    <div class="metric">
        <div class="metric-value">{{ format_cost(test.agent_result.cost_usd) }}</div>
        <div class="metric-label">Cost</div>
    </div>
    <div class="metric">
        <div class="metric-value">{{ test.agent_result.all_tool_calls | length }}</div>
        <div class="metric-label">Tool Calls</div>
    </div>
    <div class="metric">
        <div class="metric-value">{{ test.agent_result.turns | length }}</div>
        <div class="metric-label">Turns</div>
    </div>
</div>

{% if test.agent_result.turns %}
<div class="mermaid-container" onclick="event.stopPropagation(); showDiagram(this.querySelector('.mermaid').innerHTML)">
    <div class="mermaid">{{ generate_mermaid(test.agent_result) }}</div>
</div>

{% if test.agent_result.final_response %}
<div class="final-output">
    <h4>ğŸ’¬ Final Output</h4>
    <div class="content">{{ test.agent_result.final_response }}</div>
</div>
{% endif %}

<details style="margin-top: 1rem;">
    <summary style="cursor: pointer; font-size: 0.875rem; font-weight: 500; color: var(--c-text-light);">ğŸ“œ Full Conversation ({{ test.agent_result.turns | length }} turns)</summary>
    <div class="turns" style="margin-top: 0.75rem;">
    {% for turn in test.agent_result.turns %}
    <div class="turn {{ turn.role }}">
        <div class="turn-role">{{ turn.role }}</div>
        <div class="turn-content">{{ turn.content[:500] }}{{ '...' if turn.content|length > 500 else '' }}</div>
        {% for tc in turn.tool_calls %}
        <div class="tool-call">
            <span class="tool-name">ğŸ”§ {{ tc.name }}</span>
            <div class="tool-args">{{ tc.arguments | tojson }}</div>
            {% if tc.result %}
            <div class="tool-result">â†’ {{ tc.result[:200] }}{{ '...' if tc.result|length > 200 else '' }}</div>
            {% endif %}
            {% if tc.error %}
            <div class="error-message" style="margin: 0.25rem 0 0;">{{ tc.error }}</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
    </div>
</details>
{% endif %}
{% endif %}
