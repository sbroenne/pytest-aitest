{# AI Insights partial - LLM-generated structured analysis #}
{% if insights and insights.recommendation.configuration != "(analysis pending)" %}
<section class="section insights-section" style="border-left: 4px solid var(--c-secondary);">
    <div class="section-header" style="background: linear-gradient(90deg, #f3e8ff, #f8fafc);">
        <h2>ü§ñ AI Insights</h2>
    </div>
    <div class="section-body ai-insights">
        {# Primary Recommendation #}
        <div class="insight-card recommendation-card">
            <h3>üéØ Recommendation</h3>
            <div class="recommendation-summary">
                <span class="deploy-badge">Deploy: {{ insights.recommendation.configuration }}</span>
                <p class="summary-text">{{ insights.recommendation.summary }}</p>
            </div>
            <details class="reasoning-details">
                <summary>Why this configuration?</summary>
                <p>{{ insights.recommendation.reasoning }}</p>
                {% if insights.recommendation.alternatives %}
                <div class="alternatives">
                    <strong>Alternatives:</strong>
                    <ul>
                    {% for alt in insights.recommendation.alternatives %}
                        <li>{{ alt }}</li>
                    {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </details>
        </div>

        {# Failure Analysis #}
        {% if insights.failures %}
        <div class="insight-card failures-card">
            <h3>‚ùå Failure Analysis ({{ insights.failures | length }})</h3>
            {% for failure in insights.failures %}
            <div class="failure-item">
                <div class="failure-header">
                    <span class="test-name" title="{{ failure.test_id }}">{{ failure.test_id | truncate(60) }}</span>
                    <span class="config-badge">{{ failure.configuration }}</span>
                </div>
                <div class="failure-body">
                    <div class="failure-problem">
                        <strong>Problem:</strong> {{ failure.problem }}
                    </div>
                    <details>
                        <summary>Root Cause & Fix</summary>
                        <div class="failure-cause">
                            <strong>Root Cause:</strong> {{ failure.root_cause }}
                        </div>
                        <div class="failure-fix">
                            <strong>Suggested Fix:</strong>
                            <code class="suggestion-code">{{ failure.suggested_fix }}</code>
                            <button class="copy-btn" onclick="copyToClipboard(this, '{{ failure.suggested_fix | e }}')">üìã</button>
                        </div>
                    </details>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# MCP Server Feedback #}
        {% if insights.mcp_feedback %}
        <div class="insight-card mcp-feedback-card">
            <h3>üîß MCP Tool Feedback</h3>
            {% for server in insights.mcp_feedback %}
            <div class="server-feedback">
                <h4>{{ server.server_name }}</h4>
                <p class="overall-assessment">{{ server.overall_assessment }}</p>
                {% for tool in server.tools %}
                <div class="tool-feedback {{ tool.status.value }}">
                    <div class="tool-header">
                        <span class="tool-name">{{ tool.tool_name }}</span>
                        <span class="status-badge status-{{ tool.status.value }}">
                            {% if tool.status.value == 'working' %}‚úÖ{% elif tool.status.value == 'warning' %}‚ö†Ô∏è{% elif tool.status.value == 'unused' %}‚ùì{% else %}‚ùå{% endif %}
                            {{ tool.status.value }}
                        </span>
                        <span class="call-stats">{{ tool.call_count }} calls{% if tool.error_count > 0 %}, {{ tool.error_count }} errors{% endif %}</span>
                    </div>
                    {% if tool.problem %}
                    <div class="tool-body">
                        <div class="current-desc">
                            <strong>Current:</strong>
                            <code>{{ tool.current_description }}</code>
                        </div>
                        <div class="tool-problem">
                            <strong>Problem:</strong> {{ tool.problem }}
                        </div>
                        {% if tool.suggested_description %}
                        <div class="suggested-desc">
                            <strong>Suggested rewrite:</strong>
                            <code class="suggestion-code">{{ tool.suggested_description }}</code>
                            <button class="copy-btn" onclick="copyToClipboard(this, '{{ tool.suggested_description | e }}')">üìã Copy</button>
                        </div>
                        {% if tool.rationale %}
                        <div class="rationale">
                            <em>{{ tool.rationale }}</em>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Prompt Feedback #}
        {% if insights.prompt_feedback %}
        <div class="insight-card prompt-feedback-card">
            <h3>üìù Prompt Feedback</h3>
            {% for prompt in insights.prompt_feedback %}
            <div class="prompt-feedback {{ prompt.effectiveness.value }}">
                <div class="prompt-header">
                    <span class="prompt-name">{{ prompt.prompt_id }}</span>
                    <span class="effectiveness-badge effectiveness-{{ prompt.effectiveness.value }}">
                        {% if prompt.effectiveness.value == 'effective' %}‚úÖ{% elif prompt.effectiveness.value == 'mixed' %}‚ö†Ô∏è{% else %}‚ùå{% endif %}
                        {{ prompt.effectiveness.value }}
                    </span>
                    <span class="token-count">{{ prompt.token_count }} tokens</span>
                </div>
                {% if prompt.problem %}
                <div class="prompt-body">
                    <div class="current-excerpt">
                        <strong>Excerpt:</strong>
                        <code>{{ prompt.current_excerpt | truncate(200) }}</code>
                    </div>
                    <div class="prompt-problem">
                        <strong>Problem:</strong> {{ prompt.problem }}
                    </div>
                    {% if prompt.suggested_change %}
                    <div class="suggested-change">
                        <strong>Suggested change:</strong>
                        <code class="suggestion-code">{{ prompt.suggested_change }}</code>
                        <button class="copy-btn" onclick="copyToClipboard(this, '{{ prompt.suggested_change | e }}')">üìã Copy</button>
                    </div>
                    {% if prompt.rationale %}
                    <div class="rationale">
                        <em>{{ prompt.rationale }}</em>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Skill Feedback #}
        {% if insights.skill_feedback %}
        <div class="insight-card skill-feedback-card">
            <h3>üìö Skill Feedback</h3>
            {% for skill in insights.skill_feedback %}
            <div class="skill-feedback {{ skill.impact.value }}">
                <div class="skill-header">
                    <span class="skill-name">{{ skill.skill_name }}</span>
                    <span class="impact-badge impact-{{ skill.impact.value }}">
                        {% if skill.impact.value == 'positive' %}‚úÖ{% elif skill.impact.value == 'neutral' %}‚ûñ{% elif skill.impact.value == 'unused' %}‚ùì{% else %}‚ùå{% endif %}
                        {{ skill.impact.value }}
                    </span>
                    <span class="usage-rate">{{ (skill.usage_rate * 100) | round }}% used</span>
                    <span class="token-cost">{{ skill.token_cost }} tokens</span>
                </div>
                {% if skill.problem %}
                <div class="skill-body">
                    <div class="current-structure">
                        <strong>Structure:</strong> {{ skill.current_structure }}
                    </div>
                    <div class="skill-problem">
                        <strong>Problem:</strong> {{ skill.problem }}
                    </div>
                    {% if skill.suggested_change %}
                    <div class="suggested-change">
                        <strong>Suggested change:</strong>
                        <code class="suggestion-code">{{ skill.suggested_change }}</code>
                        <button class="copy-btn" onclick="copyToClipboard(this, '{{ skill.suggested_change | e }}')">üìã Copy</button>
                    </div>
                    {% if skill.rationale %}
                    <div class="rationale">
                        <em>{{ skill.rationale }}</em>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Optimization Opportunities #}
        {% if insights.optimizations %}
        <div class="insight-card optimizations-card">
            <h3>üí° Optimization Opportunities</h3>
            {% for opt in insights.optimizations %}
            <div class="optimization-item severity-{{ opt.severity.value }}">
                <div class="opt-header">
                    <span class="opt-title">{{ opt.title }}</span>
                    <span class="category-badge">{{ opt.category.value }}</span>
                    <span class="severity-badge severity-{{ opt.severity.value }}">
                        {% if opt.severity.value == 'recommended' %}üî¥{% elif opt.severity.value == 'suggestion' %}üü°{% else %}üîµ{% endif %}
                        {{ opt.severity.value }}
                    </span>
                </div>
                <div class="opt-body">
                    <div class="current-state">
                        <strong>Current:</strong> {{ opt.current_state }}
                    </div>
                    <div class="suggested-change">
                        <strong>Change:</strong> {{ opt.suggested_change }}
                    </div>
                    <div class="expected-impact">
                        <strong>Expected Impact:</strong> {{ opt.expected_impact }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</section>
{% endif %}
