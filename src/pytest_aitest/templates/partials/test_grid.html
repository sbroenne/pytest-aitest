{# Test grid - session-grouped test list with optional agent comparison #}
{# Expects: test_groups, all_agent_ids, selected_agent_ids, agents_by_id, total_tests #}

{% set comparison_mode = all_agent_ids | length > 1 %}

<div class="mb-4 flex items-center justify-between">
    <div class="flex gap-2">
        <button class="filter-btn active" data-filter="all" onclick="filterTests('all')">All</button>
        {% if comparison_mode %}
        <button class="filter-btn" data-filter="diff" onclick="filterTests('diff')">Differences âš¡</button>
        {% endif %}
        <button class="filter-btn" data-filter="failed" onclick="filterTests('failed')">Failed âŒ</button>
    </div>
    <div class="text-sm text-text-muted">
        <span id="visible-count">{{ total_tests }}</span> / {{ total_tests }} tests
    </div>
</div>

<div class="space-y-4" id="test-groups">
    {% for group in test_groups %}
    <div class="card overflow-hidden test-group" data-group-type="{{ group.type }}">
        {# Group header #}
        <div class="group-header px-5 py-3 bg-surface-elevated border-b border-white/10 flex justify-between items-center cursor-pointer"
             onclick="toggleGroup(this.parentElement)">
            <div class="flex items-center gap-3">
                <span class="text-lg">{{ 'ğŸ”—' if group.type == 'session' else 'ğŸ“‹' }}</span>
                <span class="font-medium text-text-light">{{ group.name }}</span>
                <span class="text-sm text-text-muted">({{ group.tests | length }} tests)</span>
            </div>
            <div class="flex items-center gap-4">
                {% if comparison_mode %}
                {# Per-agent summary for this group #}
                {% for agent_id in selected_agent_ids %}
                {% set stats = group.agent_stats.get(agent_id, {"passed": 0, "failed": 0, "total": 0}) %}
                <div class="text-sm {{ 'text-green-400' if stats.failed == 0 else 'text-red-400' }}">
                    {{ stats.passed }}/{{ stats.passed + stats.failed }}
                </div>
                {% endfor %}
                {% endif %}
                <span class="text-text-muted transition-transform duration-200 expand-icon">â–¼</span>
            </div>
        </div>
        
        {# Test rows #}
        <div class="group-content">
            {% for test in group.tests %}
            {% set result = test.results_by_agent.values() | first if test.results_by_agent else none %}
            <div class="test-row border-b border-white/5" 
                 data-test-id="{{ test.id }}"
                 data-has-diff="{{ 'true' if test.has_difference else 'false' }}"
                 data-has-failed="{{ 'true' if test.has_failed else 'false' }}">
                {# Test row #}
                <div class="px-5 py-3 hover:bg-white/[0.02] cursor-pointer transition-colors"
                     onclick="toggleTestDetail(this.parentElement)">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 min-w-0 flex-1">
                            {# Status icon #}
                            {% if result %}
                            <span class="{{ 'text-green-400' if result.passed else 'text-red-400' }}">
                                {{ 'âœ…' if result.passed else 'âŒ' }}
                            </span>
                            {% else %}
                            <span class="text-text-muted">âšª</span>
                            {% endif %}
                            
                            {# Test name #}
                            <span class="text-text-light truncate">{{ test.display_name }}</span>
                            
                            {# Difference indicator #}
                            {% if test.has_difference %}
                            <span class="text-yellow-400" title="Results differ between agents">âš¡</span>
                            {% endif %}
                        </div>
                        
                        {# Metrics #}
                        {% if result %}
                        <div class="flex items-center gap-4 text-sm text-text-muted">
                            <span class="tabular-nums">{{ "%.1f"|format(result.duration_s) }}s</span>
                            <span class="tabular-nums">{{ result.tool_count }}ğŸ”§</span>
                            <span class="tabular-nums">{{ "{:,}".format(result.tokens) }} tok</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {# Comparison row - show per-agent results when comparing #}
                    {% if comparison_mode %}
                    <div class="flex gap-4 mt-2 pl-8">
                        {% for agent_id in all_agent_ids %}
                        {% set agent_result = test.results_by_agent.get(agent_id) %}
                        {% set is_selected = agent_id in selected_agent_ids %}
                        <div class="agent-result-item flex items-center gap-2 text-xs {{ 'hidden' if not is_selected else '' }}" data-agent-id="{{ agent_id }}">
                            <span class="text-text-muted">{{ agents_by_id[agent_id].name }}:</span>
                            {% if agent_result %}
                            <span class="{{ 'text-green-400' if agent_result.passed else 'text-red-400' }}">
                                {{ 'âœ…' if agent_result.passed else 'âŒ' }}
                            </span>
                            <span class="text-text-muted tabular-nums">{{ "%.1f"|format(agent_result.duration_s) }}s</span>
                            {% else %}
                            <span class="text-text-muted">â€”</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                {# Expanded detail - always use comparison view #}
                <div class="test-detail hidden border-t border-white/10 bg-surface-elevated">
                    {% include 'partials/test_comparison.html' %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
.test-group.collapsed .group-content {
    display: none;
}
.test-group.collapsed .expand-icon {
    transform: rotate(-90deg);
}
.test-row.hidden {
    display: none;
}
</style>
