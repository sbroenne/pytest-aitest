<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report.name }} - Test Report</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
{% include 'partials/tailwind.css' %}
    </style>
</head>
<body class="bg-surface text-text min-h-screen">
    <div class="max-w-6xl mx-auto px-6 py-8">
        
        {# ===== HEADER ===== #}
        <header class="report-header mb-8">
            <div class="flex justify-between items-start gap-4 mb-4">
                <div class="flex-1">
                    <h1 class="text-2xl font-medium mb-1">
                        {% if report.suite_docstring %}{{ report.suite_docstring }}
                        {% else %}Test Report{% endif %}
                    </h1>
                </div>
                {% if report.failed == 0 and report.passed > 0 %}
                <div class="status-passed"><span>‚úì</span><span>All Passed</span></div>
                {% elif report.failed > 0 %}
                <div class="status-failed"><span>‚úó</span><span>{{ report.failed }} Failed</span></div>
                {% endif %}
            </div>
            
            <div class="flex flex-wrap gap-x-6 gap-y-1 py-3 border-t border-white/10 text-sm">
                <span class="opacity-70">{{ report.timestamp }}</span>
                <span class="tabular-nums">{{ report.total }} tests</span>
                <span class="tabular-nums">{{ "%.1f"|format(report.duration_ms / 1000) }}s</span>
                <span class="tabular-nums">{{ format_cost(report.total_cost_usd or 0) }}</span>
                {% if report.analysis_metadata %}
                <span class="opacity-70" title="AI Analysis cost">ü§ñ {{ format_cost(report.analysis_metadata.cost_usd) }}</span>
                {% endif %}
            </div>
        </header>

        {# ===== AI INSIGHTS ===== #}
        {% if insights and insights.markdown_summary and "pending" not in insights.markdown_summary %}
        <section class="mb-8">
            <div class="ai-insights">
                <div class="ai-insights-header">
                    <span>ü§ñ</span>
                    <span>AI Analysis</span>
                    <button class="ml-auto text-text-muted hover:text-text-light text-sm" 
                            onclick="this.closest('.ai-insights').querySelector('.card-body').classList.toggle('hidden')">
                        Toggle
                    </button>
                </div>
                <div class="card-body">
                    <div class="markdown-content">
                        {{ insights.markdown_summary | markdown | safe }}
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        {# ===== AGENT LEADERBOARD ===== #}
        {% if agents | length > 0 %}
        <section class="mb-8">
            <h2 class="section-title">üèÜ Agent Leaderboard</h2>
            {% include 'partials/agent_leaderboard.html' %}
        </section>
        {% endif %}

        {# ===== AGENT SELECTOR (only show when > 2 agents) ===== #}
        {% if agents | length > 2 %}
        <section class="mb-8">
            {% include 'partials/agent_selector.html' %}
        </section>
        {% endif %}

        {# ===== TEST RESULTS ===== #}
        <section class="mb-8">
            <h2 class="section-title">üìã Test Results</h2>
            {% include 'partials/test_grid.html' %}
        </section>

    </div>

    {# Fullscreen Overlay #}
    {% include 'partials/overlay.html' %}

    <script>
{% include 'partials/scripts.js' %}

// All agent data for client-side filtering
const allAgents = {{ agents | tojson | safe }};
const allAgentsById = {{ agents_by_id | tojson | safe }};

// Track selected agents (exactly 2)
let selectedAgentIds = {{ selected_agent_ids | tojson | safe }};

// Agent comparison logic - always keep exactly 2 selected
function updateAgentComparison(clickedAgentId) {
    const checkboxes = document.querySelectorAll('input[name="compare-agent"]');
    
    // If clicking an already-selected agent, do nothing (keep 2 selected)
    if (selectedAgentIds.includes(clickedAgentId)) {
        // Re-check it to prevent unchecking
        checkboxes.forEach(cb => {
            if (cb.value === clickedAgentId) {
                cb.checked = true;
            }
        });
        return;
    }
    
    // Replace the oldest selection with the new one
    selectedAgentIds.shift();  // Remove first (oldest)
    selectedAgentIds.push(clickedAgentId);  // Add new one
    
    // Update all checkboxes to match selectedAgentIds
    checkboxes.forEach(cb => {
        cb.checked = selectedAgentIds.includes(cb.value);
        cb.closest('.agent-chip').classList.toggle('selected', cb.checked);
    });
    
    // Update visible columns in test comparison
    document.querySelectorAll('.comparison-column').forEach(col => {
        const agentId = col.dataset.agentId;
        if (agentId) {
            const shouldShow = selectedAgentIds.includes(agentId);
            col.classList.toggle('hidden', !shouldShow);
            
            // Render mermaid diagrams in newly visible columns
            if (shouldShow) {
                const diagrams = col.querySelectorAll('.mermaid:not([data-processed])');
                if (diagrams.length > 0) {
                    mermaid.run({ nodes: diagrams });
                }
            }
        }
    });
    
    // Update comparison grid layout based on visible columns
    document.querySelectorAll('.comparison-grid').forEach(grid => {
        const visibleCols = grid.querySelectorAll('.comparison-column:not(.hidden)').length;
        grid.style.gridTemplateColumns = `repeat(${visibleCols}, 1fr)`;
    });
    
    // Update agent cards visibility
    document.querySelectorAll('.agent-card[data-card-id]').forEach(card => {
        const agentId = card.dataset.cardId;
        card.classList.toggle('hidden', !selectedAgentIds.includes(agentId));
    });
    
    // Update comparison row agent results
    document.querySelectorAll('.agent-result-item').forEach(item => {
        const agentId = item.dataset.agentId;
        item.classList.toggle('hidden', !selectedAgentIds.includes(agentId));
    });
    
    console.log('Selected agents:', selectedAgentIds);
}

// Test filtering
function filterTests(filter) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
    });
    
    let visibleCount = 0;
    document.querySelectorAll('.test-row').forEach(row => {
        let show = true;
        if (filter === 'diff') {
            show = row.dataset.hasDiff === 'true';
        } else if (filter === 'failed') {
            show = row.dataset.hasFailed === 'true';
        }
        row.classList.toggle('hidden', !show);
        if (show) visibleCount++;
    });
    
    document.getElementById('visible-count').textContent = visibleCount;
}

// Group toggle
function toggleGroup(group) {
    group.classList.toggle('collapsed');
}

// Test detail toggle - also renders mermaid diagrams when expanded
function toggleTestDetail(row) {
    const detail = row.querySelector('.test-detail');
    const wasHidden = detail.classList.contains('hidden');
    detail.classList.toggle('hidden');
    
    // If we're showing the detail, render any mermaid diagrams
    if (wasHidden) {
        const diagrams = detail.querySelectorAll('.mermaid:not([data-processed])');
        if (diagrams.length > 0) {
            mermaid.run({ nodes: diagrams });
        }
    }
}

// Initialize on page load - process visible mermaid diagrams
document.addEventListener('DOMContentLoaded', () => {
    // Mermaid should auto-process with startOnLoad, but just in case
    const visibleDiagrams = document.querySelectorAll('.mermaid:not(.hidden .mermaid)');
    if (visibleDiagrams.length > 0) {
        mermaid.run({ nodes: visibleDiagrams });
    }
});
    </script>
</body>
</html>
